<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UOC Exam Management V90 (FIXED)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PyScript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>

    <style>
        /* Loading Spinner */
        .loader-spin {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Navigation (V87: Colorful, Rounded, Elevated) */
        .nav-button {
            @apply py-2.5 px-5 rounded-t-xl text-sm font-semibold transition-all duration-200 text-white shadow;
        }
        .nav-button-active {
            @apply shadow-lg scale-105 transform -translate-y-1;
        }
        .nav-button-inactive {
            @apply opacity-90 hover:opacity-100 transform;
        }

        #top-banner { background-color: #4f46e5; }
        #main-nav-tabs { background-color: #1f2937; padding-top: 4px; }

        #nav-extractor { background-color: #2563eb; }
        #nav-extractor.nav-button-active { background-color: #dbeafe; color: #1d4ed8; }

        #nav-settings { background-color: #16a34a; }
        #nav-settings.nav-button-active { background-color: #dcfce7; color: #15803d; }

        #nav-room-settings { background-color: #9333ea; }
        #nav-room-settings.nav-button-active { background-color: #f3e8ff; color: #7e22ce; }

        #nav-qpcodes { background-color: #ca8a04; }
        #nav-qpcodes.nav-button-active { background-color: #fef9c3; color: #a16207; }

        #nav-reports { background-color: #dc2626; }
        #nav-reports.nav-button-active { background-color: #fee2e2; color: #b91c1c; }

        #nav-absentees { background-color: #db2777; }
        #nav-absentees.nav-button-active { background-color: #fce7f3; color: #be185d; }

        /* Print Styles */
        @media print {
            #main-nav, #view-extractor, #view-settings, #view-reports, #view-absentees, #view-qpcodes, #view-room-settings,
            body > py-config, body > py-script, #report-controls { display: none !important; }
            #report-output-area { display: block !important; visibility: visible !important; position: static; width: 100%; overflow-y: visible; }
            .print-page { display: block !important; page-break-after: always; page-break-inside: avoid; width: 100%; padding: 1cm; box-shadow: none; border: none; margin: 0; }
            h1 { font-size: 16pt; } h2 { font-size: 14pt; } h3 { font-size: 12pt; }
            table { font-size: 8.5pt; }
            th, td { border: 1px solid black; padding: 8px 3px; }
            .print-table, .daywise-report-table, .absentee-report-table { break-before: avoid; }
            .print-header-group { break-inside: avoid; }
            .daywise-report-table { font-size: 6pt; }
            .absentee-report-table { font-size: 10pt; }
        }

        /* On-Screen Report Preview */
        .print-page {
            background: white; width: 210mm; min-height: 297mm; padding: 2cm; margin: 1rem auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); font-size: 9pt;
        }
        .print-page table { font-size: 8.5pt; }
        .daywise-report-table { font-size: 6pt; table-layout: fixed; }
        .absentee-report-table { font-size: 10pt; }

        /* Autocomplete */
        .autocomplete-container { position: relative; }
        .autocomplete-results {
            position: absolute; border: 1px solid #d1d5db; background-color: #ffffff;
            max-height: 200px; overflow-y: auto; width: 100%; z-index: 10;
            border-radius: 0 0 0.375rem 0.375rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .autocomplete-item { padding: 0.5rem 0.75rem; cursor: pointer; }
        .autocomplete-item:hover, .autocomplete-item-active { background-color: #f3f4f6; }
        .autocomplete-item strong { color: #4f46e5; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Navigation -->
    <nav id="main-nav" class="bg-indigo-600 text-white sticky top-0 z-50 shadow-lg">
        <div id="top-banner" class="w-full bg-indigo-700 text-center py-2">
            <h1 class="text-xl font-extrabold tracking-wider text-white">UOC Exam Management (V90)</h1>
        </div>
        <div id="main-nav-tabs" class="container max-w-2xl mx-auto flex justify-center gap-2">
            <button id="nav-extractor" class="nav-button nav-button-active">Main Extractor</button>
            <button id="nav-settings" class="nav-button nav-button-inactive">Settings</button>
            <button id="nav-room-settings" class="nav-button nav-button-inactive">Room Settings</button>
            <button id="nav-qpcodes" class="nav-button nav-button-inactive">QP Codes</button>
            <button id="nav-reports" class="nav-button nav-button-inactive">Reports</button>
            <button id="nav-absentees" class="nav-button nav-button-inactive">Absentees</button>
        </div>
    </nav>

    <!-- Main Extractor -->
    <div id="view-extractor" class="container max-w-2xl mx-auto p-4 min-h-screen">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Data Extractor</h1>
            <div class="bg-indigo-50 border border-indigo-200 p-4 rounded-md mb-6">
                <h4 class="font-semibold text-gray-800">How to Use:</h4>
                <ol class="list-decimal list-inside text-sm text-gray-700 mt-2 space-y-1">
                    <li>Go to <strong>Room Settings</strong> and define capacities and locations. Save changes.</li>
                    <li>Click 'Select PDF Files' and choose 1 or 100+ PDF files.</li>
                    <li>Click 'Run Batch Extraction'. Check the <strong>Status Log</strong> for errors.</li>
                    <li>Click 'Download Combined_Nominal_Roll.csv' for raw data.</li>
                    <li>(Optional) Go to <strong>QP Codes</strong> to assign codes to each course.</li>
                    <li>Go to <strong>Reports</strong> to generate seating lists, day-wise lists, and question paper counts.</li>
                    <li>Go to <strong>Absentees</strong> to mark absentees and generate the final statement.</li>
                </ol>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="pdf-file" class="block text-sm font-medium text-gray-700">1. Select PDF Files:</label>
                    <input type="file" id="pdf-file" accept=".pdf" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                </div>
                <button id="run-button" py-click="start_extraction" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-indigo-600 py-3 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 disabled:opacity-50">
                    <span id="spinner" class="loader-spin -ml-1 mr-3 h-5 w-5 text-white hidden"></span>
                    <span id="button-text">2. Run Batch Extraction</span>
                </button>
            </div>

            <div class="mt-6">
                <h3 class="text-lg font-medium text-gray-900">Processing Log:</h3>
                <div id="status" class="w-full h-48 p-3 mt-2 bg-gray-900 text-gray-200 text-sm font-mono rounded-md overflow-y-auto">Waiting for file...</div>
            </div>

            <div class="mt-6">
                <h3 class="text-lg font-medium text-gray-900">Status Log:</h3>
                <div id="status-log" class="w-full h-48 p-3 mt-2 bg-gray-100 border border-gray-300 text-gray-800 text-sm font-mono rounded-md overflow-y-auto">Waiting for extraction to complete...</div>
            </div>

            <div id="download-area" class="mt-6 space-y-3">
                <div id="csv-download-container"></div>
            </div>

            <div class="bg-gray-50 border border-gray-200 p-4 rounded-md mt-6">
                <h4 class="font-semibold text-gray-800">3. Load Corrected Data (Optional)</h4>
                <p class="text-sm text-gray-600 mt-1 mb-3">Upload a corrected <code>Combined_Nominal_Roll.csv</code> to overwrite extracted data.</p>
                <div class="flex items-center gap-2">
                    <input type="file" id="corrected-csv-upload" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100"/>
                    <button id="load-csv-button" class="inline-flex justify-center items-center rounded-md border border-transparent bg-gray-600 py-2 px-3 text-sm font-medium text-white shadow-sm hover:bg-gray-700">Load CSV</button>
                </div>
                <span id="csv-load-status" class="text-sm font-medium text-green-600 mt-2 block h-5"></span>
            </div>
        </div>
    </div>

    <!-- General Settings -->
    <div id="view-settings" class="container max-w-2xl mx-auto p-4 min-h-screen hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">General Settings</h1>
            <div class="bg-red-50 border border-red-200 p-4 rounded-lg mb-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-300">College Name</h2>
                <div class="mb-6">
                    <label for="college-name-input" class="block text-sm font-medium text-gray-700 mb-1">College Name (for Reports)</label>
                    <input type="text" id="college-name-input" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="e.g., University of Calicut">
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-4 pb-2 border-b border-gray-300">Master Reset</h2>
                <button id="master-reset-button" class="w-full inline-flex justify-center items-center rounded-md border border-red-700 bg-red-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700 mt-2">
                    Master Reset: Clear ALL Local Data
                </button>
            </div>
        </div>
    </div>

    <!-- Room Settings -->
    <div id="view-room-settings" class="container max-w-2xl mx-auto p-4 min-h-screen hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Room Capacity & Location</h1>
            <p class="text-gray-600 mb-4">Define the number of students per room. Blank capacity defaults to 30.</p>
            <div class="space-y-4">
                <div class="flex items-center gap-3 px-2">
                    <label class="font-semibold text-gray-700 w-24 shrink-0">Room Name</label>
                    <label class="font-semibold text-gray-700 w-20">Capacity</label>
                    <label class="font-semibold text-gray-700 flex-grow">Location</label>
                </div>
                <div id="room-config-container" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                <button id="add-room-button" class="w-full inline-flex justify-center items-center rounded-md border border-dashed border-gray-400 bg-gray-50 py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-100">+ Add New Room</button>
                <hr class="my-4">
                <button id="save-room-config-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-indigo-600 py-3 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">Save Room Settings</button>
                <div id="room-config-status" class="text-sm text-green-600 font-medium text-center h-5"></div>
            </div>
        </div>
    </div>

    <!-- QP Codes -->
    <div id="view-qpcodes" class="container max-w-2xl mx-auto p-4 min-h-screen hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">QP Code Settings</h1>
            <div id="qpcode-content-wrapper" class="hidden">
                <div class="mb-4">
                    <label for="session-select-qp" class="block text-sm font-medium text-gray-700 mb-1">Select Exam Session:</label>
                    <select id="session-select-qp" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                        <option value="">-- Select a Session --</option>
                    </select>
                </div>
                <div id="qp-entry-section" class="hidden">
                    <p class="text-gray-600 mb-4">Assign a QP Code to each course. Click <strong>Save QP Codes</strong> to commit.</p>
                    <div class="space-y-4">
                        <div class="flex items-center gap-3 px-2">
                            <label class="font-semibold text-gray-700 w-2/3">Course Name</label>
                            <label class="font-semibold text-gray-700 w-1/3">QP Code</label>
                        </div>
                        <div id="qp-code-container" class="space-y-2 max-h-96 overflow-y-auto pr-2"></div>
                    </div>
                    <div id="qp-code-status" class="text-sm text-green-600 font-medium text-center h-5 mt-4"></div>
                    <button id="save-qp-codes-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-indigo-600 py-3 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 mt-4" disabled>Save QP Codes</button>
                </div>
            </div>
            <div id="qpcode-loader" class="text-center text-gray-600">
                <p>Please run a data extraction or load a corrected CSV to enable this feature.</p>
            </div>
        </div>
    </div>

    <!-- Reports -->
    <div id="view-reports" class="container max-w-2xl mx-auto p-4 min-h-screen hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Reports</h1>
            <p class="text-gray-600 mb-4">Generate reports based on the last loaded data.</p>
            <div id="report-filter-section" class="bg-gray-100 p-4 rounded-lg mb-6 hidden">
                <h4 class="font-semibold text-gray-700 mb-2">Filter Reports By:</h4>
                <div class="flex flex-col sm:flex-row gap-4 mb-3">
                    <div class="flex items-center">
                        <input type="radio" id="filter-all" name="report-filter" value="all" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                        <label for="filter-all" class="ml-2 text-sm text-gray-700 font-medium">All Sessions (Bulk Print)</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="filter-session" name="report-filter" value="session" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                        <label for="filter-session" class="ml-2 text-sm text-gray-700 font-medium">Specific Session</label>
                    </div>
                </div>
                <div id="reports-session-dropdown-container">
                    <select id="reports-session-select" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                        <option value="">-- Select a Session --</option>
                    </select>
                </div>
            </div>
            <div class="space-y-4">
                <button id="generate-report-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:opacity-50" disabled>Generate Room-wise Seating Report</button>
                <button id="generate-daywise-report-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:opacity-50" disabled>Generate Seating Details for Candidates (Compact)</button>
                <button id="generate-qpaper-report-button" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white shadow-sm hover:bg-blue-700 disabled:opacity-50" disabled>Generate Question Paper Report</button>
            </div>
        </div>
    </div>

    <!-- Absentees -->
    <div id="view-absentees" class="container max-w-2xl mx-auto p-4 min-h-screen hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">Mark Absentees</h1>
            <div id="absentee-content-wrapper" class="hidden">
                <div class="mb-4">
                    <label for="session-select" class="block text-sm font-medium text-gray-700 mb-1">Select Exam Session:</label>
                    <select id="session-select" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm">
                        <option value="">-- Select a Session --</option>
                    </select>
                </div>
                <div id="absentee-search-section" class="mb-6 hidden">
                    <div class="autocomplete-container">
                        <label for="absentee-search" class="block text-sm font-medium text-gray-700 mb-1">Search Register Number:</label>
                        <input type="text" id="absentee-search" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="Type reg no...">
                        <div id="autocomplete-results" class="autocomplete-results hidden"></div>
                    </div>
                    <div id="selected-student-details" class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded hidden">
                        <p><strong>Name:</strong> <span id="selected-student-name"></span></p>
                        <p><strong>Course:</strong> <span id="selected-student-course"></span></p>
                        <p><strong>Room:</strong> <span id="selected-student-room"></span></p>
                    </div>
                    <button id="add-absentee-button" class="mt-3 inline-flex justify-center items-center rounded-md border border-transparent bg-red-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700" disabled>Add to Absentee List</button>
                </div>
                <div id="absentee-list-section" class="hidden">
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Current Absentees:</h3>
                    <div id="current-absentee-list" class="space-y-2"></div>
                </div>
                <button id="generate-absentee-report-button" class="mt-6 w-full inline-flex justify-center items-center rounded-md border border-transparent bg-green-600 py-3 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 disabled:opacity-50" disabled>Generate Absentee Statement</button>
            </div>
            <div id="absentee-loader" class="text-center text-gray-600">
                <p>Please run a data extraction or load a corrected CSV to enable this feature.</p>
            </div>
        </div>
    </div>

    <!-- Report Output -->
    <div id="report-output-area" class="container max-w-5xl mx-auto p-4 hidden"></div>
    <div id="report-controls" class="fixed bottom-4 right-4 space-x-2 hidden">
        <button id="print-report-button" class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">Print</button>
        <button id="close-report-button" class="bg-gray-600 text-white px-4 py-2 rounded shadow hover:bg-gray-700">Close</button>
    </div>

    <!-- Hidden Data Stores -->
    <div id="jsonDataStore" class="hidden"></div>
    <div id="qPaperDataStore" class="hidden"></div>

    <!-- PyScript Config -->
    <py-config>
        packages = ["pdfplumber", "pandas"]
    </py-config>

    <py-script>
import pdfplumber
import json
import re
from js import document, console, window, localStorage, FileReader, Blob, URL, setTimeout
from pyodide.ffi import create_proxy

# === GLOBALS ===
BASE_DATA_KEY = "examBaseData"
ROOM_CONFIG_KEY = "examRoomConfig"
COLLEGE_NAME_KEY = "examCollegeName"
ABSENTEE_LIST_KEY = "examAbsentees"
QP_CODE_LIST_KEY = "examQPCodes"

# === UI ELEMENTS ===
jsonDataStore = document.getElementById("jsonDataStore")
qPaperDataStore = document.getElementById("qPaperDataStore")
status = document.getElementById("status")
statusLog = document.getElementById("status-log")
csvDownloadContainer = document.getElementById("csv-download-container")
correctedCsvUpload = document.getElementById("corrected-csv-upload")
loadCsvButton = document.getElementById("load-csv-button")
csvLoadStatus = document.getElementById("csv-load-status")

# Navigation
navButtons = {
    "extractor": document.getElementById("nav-extractor"),
    "settings": document.getElementById("nav-settings"),
    "room-settings": document.getElementById("nav-room-settings"),
    "qpcodes": document.getElementById("nav-qpcodes"),
    "reports": document.getElementById("nav-reports"),
    "absentees": document.getElementById("nav-absentees")
}

views = {
    "extractor": document.getElementById("view-extractor"),
    "settings": document.getElementById("view-settings"),
    "room-settings": document.getElementById("view-room-settings"),
    "qpcodes": document.getElementById("view-qpcodes"),
    "reports": document.getElementById("view-reports"),
    "absentees": document.getElementById("view-absentees")
}

# Reports
generateReportButton = document.getElementById("generate-report-button")
generateDaywiseReportButton = document.getElementById("generate-daywise-report-button")
generateQPaperReportButton = document.getElementById("generate-qpaper-report-button")
reportOutputArea = document.getElementById("report-output-area")
reportControls = document.getElementById("report-controls")
printReportButton = document.getElementById("print-report-button")
closeReportButton = document.getElementById("close-report-button")

# QP Codes
sessionSelectQP = document.getElementById("session-select-qp")
qpEntrySection = document.getElementById("qp-entry-section")
qpCodeContainer = document.getElementById("qp-code-container")
saveQpCodesButton = document.getElementById("save-qp-codes-button")
qpCodeStatus = document.getElementById("qp-code-status")
qpcodeContentWrapper = document.getElementById("qpcode-content-wrapper")
qpcodeLoader = document.getElementById("qpcode-loader")

# Absentees
sessionSelect = document.getElementById("session-select")
absenteeSearchInput = document.getElementById("absentee-search")
autocompleteResults = document.getElementById("autocomplete-results")
selectedStudentDetails = document.getElementById("selected-student-details")
selectedStudentName = document.getElementById("selected-student-name")
selectedStudentCourse = document.getElementById("selected-student-course")
selectedStudentRoom = document.getElementById("selected-student-room")
addAbsenteeButton = document.getElementById("add-absentee-button")
currentAbsenteeListDiv = document.getElementById("current-absentee-list")
generateAbsenteeReportButton = document.getElementById("generate-absentee-report-button")
absenteeSearchSection = document.getElementById("absentee-search-section")
absenteeListSection = document.getElementById("absentee-list-section")
absenteeContentWrapper = document.getElementById("absentee-content-wrapper")
absenteeLoader = document.getElementById("absentee-loader")

# Report Filters
filterAllRadio = document.getElementById("filter-all")
filterSessionRadio = document.getElementById("filter-session")
reportsSessionSelect = document.getElementById("reports-session-select")
reportsSessionDropdownContainer = document.getElementById("reports-session-dropdown-container")
reportFilterSection = document.getElementById("report-filter-section")

# Room Settings
roomConfigContainer = document.getElementById("room-config-container")
addRoomButton = document.getElementById("add-room-button")
saveRoomConfigButton = document.getElementById("save-room-config-button")
roomConfigStatus = document.getElementById("room-config-status")
collegeNameInput = document.getElementById("college-name-input")

# === STATE ===
allStudentData = []
allStudentSessions = []
currentRoomConfig = {}
qpCodeMap = {}
currentAbsenteeList = []
selectedStudent = None

# === NAVIGATION ===
def switch_view(target):
    for view in views.values():
        view.classList.add("hidden")
    for btn in navButtons.values():
        btn.classList.remove("nav-button-active")
        btn.classList.add("nav-button-inactive")
    views[target].classList.remove("hidden")
    navButtons[target].classList.add("nav-button-active")
    navButtons[target].classList.remove("nav-button-inactive")

for key, btn in navButtons.items():
    btn.onclick = create_proxy(lambda e, k=key: switch_view(k))

# === PDF EXTRACTION ===
def start_extraction(*args, **kwargs):
    files = document.getElementById("pdf-file").files
    if not files.length:
        status.innerHTML = "Please select at least one PDF file."
        return

    status.innerHTML = "Starting batch extraction..."
    statusLog.innerHTML = ""
    csvDownloadContainer.innerHTML = ""
    document.getElementById("run-button").disabled = True
    document.getElementById("spinner").classList.remove("hidden")
    document.getElementById("button-text").textContent = "Processing..."

    combined_data = []
    qpaper_summary = {}
    file_count = files.length
    processed = 0

    def process_file(file_idx):
        nonlocal processed
        if file_idx >= file_count:
            finalize_extraction(combined_data, qpaper_summary)
            return

        file = files[file_idx]
        reader = FileReader()
        reader.onload = create_proxy(lambda e: on_file_loaded(e, file.name, file_idx, process_file))
        reader.readAsArrayBuffer(file)

    def on_file_loaded(event, filename, idx, callback):
        nonlocal processed
        try:
            data = event.target.result
            with pdfplumber.open(data) as pdf:
                pages = pdf.pages
                if not pages:
                    log_status(f"{filename}: Empty PDF")
                    processed += 1
                    callback(processed)
                    return

                # Extract Date, Time, Course from first page
                first_page = pages[0]
                text = first_page.extract_text()
                date_match = re.search(r"Date\s*:\s*([\d\.]+)", text)
                time_match = re.search(r"Time\s*:\s*([\d:\-–]+)", text)
                course_match = re.search(r"Course\s*:\s*(.+)", text)

                date = date_match.group(1).strip() if date_match else "Unknown"
                time = time_match.group(1).strip().replace("–", "-") if time_match else "Unknown"
                course = course_match.group(1).strip() if course_match else "Unknown Course"

                # Normalize course name
                course = re.sub(r"\s*\(cid:\d+\)\s*", "", course)
                course_code_match = re.search(r"\(([^)]+)\)$", course)
                if course_code_match:
                    code = course_code_match.group(1)
                    course_name = course[:course_code_match.start()].strip()
                    course = f"{course_name}--({code})"

                students = []
                for page_num, page in enumerate(pages):
                    tables = page.extract_tables()
                    if tables:
                        for table in tables:
                            for row in table[1:]:
                                if len(row) >= 2 and row[0] and row[1]:
                                    reg = row[0].strip()
                                    name = row[1].strip()
                                    if reg and name:
                                        students.append({"Date": date, "Time": time, "Course": course, "Register Number": reg, "Name": name})
                    else:
                        text_lines = page.extract_text().split("\n")
                        for line in text_lines:
                            reg_match = re.search(r"\b\d{10,12}\b", line)
                            if reg_match:
                                reg = reg_match.group(0)
                                name_part = line[reg_match.end():].strip().split()[0:3]
                                name = " ".join(name_part)
                                if reg and name:
                                    students.append({"Date": date, "Time": time, "Course": course, "Register Number": reg, "Name": name})

                if students:
                    combined_data.extend(students)
                    key = f"{date}_{time}_{course}"
                    if key not in qpaper_summary:
                        qpaper_summary[key] = {"Date": date, "Time": time, "Course": course, "Student Count": 0}
                    qpaper_summary[key]["Student Count"] += len(students)

                log_status(f"{filename}: {len(students)} students extracted")
        except Exception as e:
            log_status(f"{filename}: Error - {str(e)}")
            console.error(e)
        processed += 1
        status.innerHTML = f"Processing {processed}/{file_count}..."
        callback(processed)

    def finalize_extraction(data, summary):
        jsonDataStore.innerHTML = json.dumps(data)
        qPaperDataStore.innerHTML = json.dumps(list(summary.values()))
        localStorage.setItem(BASE_DATA_KEY, json.dumps(data))

        csv_content = "Date,Time,Course,Register Number,Name\n"
        for s in data:
            csv_content += f'"{s["Date"]}","{s["Time"]}","{s["Course"]}","{s["Register Number"]}","{s["Name"]}"\n'

        blob = Blob([csv_content], {type: "text/csv"})
        url = URL.createObjectURL(blob)
        link = document.createElement("a")
        link.href = url
        link.download = "Combined_Nominal_Roll.csv"
        link.textContent = "Download Combined_Nominal_Roll.csv"
        link.className = "text-blue-600 hover:text-blue-800 underline"
        csvDownloadContainer.innerHTML = ""
        csvDownloadContainer.appendChild(link)

        status.innerHTML = f"Extraction complete! {len(data)} records."
        document.getElementById("spinner").classList.add("hidden")
        document.getElementById("button-text").textContent = "2. Run Batch Extraction"
        document.getElementById("run-button").disabled = False

        enable_reports()
        disable_absentee_tab(False)
        disable_qpcode_tab(False)
        populate_session_dropdown()
        populate_qp_code_session_dropdown()

    process_file(0)

def log_status(msg):
    p = document.createElement("p")
    p.className = "mb-1"
    p.textContent = f"> [{window.Date().toLocaleTimeString()}] {msg}"
    statusLog.appendChild(p)
    statusLog.scrollTop = statusLog.scrollHeight

# === ROOM ALLOCATION ===
def performRoomAllocation(students):
    if not students:
        return []
    sorted_students = sorted(students, key=lambda x: (x["Date"], x["Time"], x["Course"], x["Register Number"]))
    rooms = sorted(currentRoomConfig.keys(), key=lambda x: int(re.search(r"\d+", x).group()) if re.search(r"\d+", x) else 0)
    allocated = []
    room_idx = 0
    for student in sorted_students:
        room = rooms[room_idx % len(rooms)] if rooms else "Unknown"
        allocated.append({**student, "Room No": room})
        room_idx += 1
    return allocated

# === REPORT GENERATION ===
def generate_report(report_type):
    data = json.loads(jsonDataStore.innerHTML or "[]")
    if not data:
        alert("No data available. Please extract or load CSV first.")
        return

    college_name = localStorage.getItem(COLLEGE_NAME_KEY) or "University of Calicut"
    allocated_data = performRoomAllocation(data)

    output = f"<div class='space-y-8'>"
    if report_type == "roomwise":
        sessions = {}
        for s in allocated_data:
            key = f"{s['Date']} | {s['Time']}"
            if key not in sessions:
                sessions[key] = []
            sessions[key].append(s)

        for session, students in sessions.items():
            date, time = session.split(" | ")
            output += f"<div class='print-page'><h1>{college_name}</h1><h2>Room-wise Seating Arrangement</h2><h3>{date} | {time}</h3>"
            room_groups = {}
            for s in students:
                room = s["Room No"]
                if room not in room_groups:
                    room_groups[room] = []
                room_groups[room].append(s)

            for room, studs in room_groups.items():
                location = currentRoomConfig.get(room, {}).get("location", "")
                loc_header = f" ({location})" if location else ""
                output += f"<div class='report-location-header'>Room {room}{loc_header}</div>"
                output += "<table class='print-table'><thead><tr><th class='sl-col'>Sl No</th><th class='reg-col'>Register Number</th><th class='name-col'>Name</th><th class='signature-col'>Signature</th></tr></thead><tbody>"
                for i, s in enumerate(studs, 1):
                    output += f"<tr><td>{i}</td><td>{s['Register Number']}</td><td>{s['Name']}</td><td></td></tr>"
                output += "</tbody></table></div>"
            output += "<div class='print-page-break'></div>"

    elif report_type == "daywise":
        sessions = {}
        for s in allocated_data:
            key = f"{s['Date']} | {s['Time']}"
            if key not in sessions:
                sessions[key] = []
            sessions[key].append(s)

        for session, students in sessions.items():
            date, time = session.split(" | ")
            output += f"<div class='print-page print-page-daywise'><h1>{college_name}</h1><h2>Seating Details - {date} | {time}</h2>"
            course_groups = {}
            for s in students:
                course = s["Course"]
                if course not in course_groups:
                    course_groups[course] = []
                course_groups[course].append(s)

            left_col = ""
            right_col = ""
            total = sum(len(v) for v in course_groups.values())
            half = (total + 1) // 2
            current = 0

            for course, studs in course_groups.items():
                block = f"<div class='print-header-group mb-2'><strong>{course}</strong><table class='daywise-report-table'><thead><tr><th>Reg No</th><th>Name</th><th>Room</th><th>Sl No</th></tr></thead><tbody>"
                for i, s in enumerate(studs, 1):
                    room = s["Room No"]
                    loc = f" ({currentRoomConfig.get(room, {}).get('location', '')})" if room in currentRoomConfig else ""
                    block += f"<tr><td>{s['Register Number']}</td><td>{s['Name']}</td><td>{room}{loc}</td><td>{i}</td></tr>"
                block += "</tbody></table></div>"

                if current < half:
                    left_col += block
                    current += len(studs)
                else:
                    right_col += block

            output += "<div class='column-container'><div class='column'>" + left_col + "</div><div class='column'>" + right_col + "</div></div></div>"

    elif report_type == "qpaper":
        summary = json.loads(qPaperDataStore.innerHTML or "[]")
        sessions = {}
        for item in summary:
            key = f"{item['Date']} | {item['Time']}"
            if key not in sessions:
                sessions[key] = []
            sessions[key].append(item)

        for session, items in sessions.items():
            date, time = session.split(" | ")
            output += f"<div class='print-page'><h1>{college_name}</h1><h2>Question Paper Requirement - {date} | {time}</h2>"
            output += "<table class='q-paper-table print-table'><thead><tr><th class='sl-col'>Sl No</th><th class='course-col'>Course</th><th class='count-col'>Count</th></tr></thead><tbody>"
            total = 0
            for i, item in enumerate(items, 1):
                output += f"<tr><td>{i}</td><td>{item['Course']}</td><td>{item['Student Count']}</td></tr>"
                total += item['Student Count']
            output += f"</tbody><tfoot><tr><td colspan='2'><strong>Total</strong></td><td><strong>{total}</strong></td></tr></tfoot></table></div>"

    output += "</div>"
    reportOutputArea.innerHTML = output
    reportOutputArea.classList.remove("hidden")
    reportControls.classList.remove("hidden")

printReportButton.onclick = lambda e: window.print()
closeReportButton.onclick = lambda e: (reportOutputArea.classList.add("hidden"), reportControls.classList.add("hidden"))

generateReportButton.onclick = lambda e: generate_report("roomwise")
generateDaywiseReportButton.onclick = lambda e: generate_report("daywise")
generateQPaperReportButton.onclick = lambda e: generate_report("qpaper")

# === ROOM SETTINGS ===
def loadRoomConfig():
    saved = localStorage.getItem(ROOM_CONFIG_KEY)
    global currentRoomConfig
    currentRoomConfig = json.loads(saved) if saved else {}
    collegeNameInput.value = localStorage.getItem(COLLEGE_NAME_KEY) or ""

    roomConfigContainer.innerHTML = ""
    if not currentRoomConfig:
        for i in range(1, 31):
            name = f"Room {i}"
            currentRoomConfig[name] = {"capacity": 30, "location": ""}
            add_room_row(name, 30, "")
    else:
        for name, info in currentRoomConfig.items():
            add_room_row(name, info.get("capacity", 30), info.get("location", ""))

def add_room_row(name, capacity, location):
    row = document.createElement("div")
    row.className = "flex items-center gap-3"
    row.innerHTML = f"""
        <input type="text" value="{name}" class="room-name block w-24 p-2 border border-gray-300 rounded-md text-sm">
        <input type="number" value="{capacity}" class="room-capacity block w-20 p-2 border border-gray-300 rounded-md text-sm">
        <input type="text" value="{location}" class="room-location flex-grow p-2 border border-gray-300 rounded-md text-sm">
        <button class="remove-room text-red-600 hover:text-red-800 text-xl">&times;</button>
    """
    row.querySelector(".remove-room").onclick = lambda e: row.remove()
    roomConfigContainer.appendChild(row)

addRoomButton.onclick = lambda e: add_room_row("", 30, "")
saveRoomConfigButton.onclick = lambda e: save_room_config()

def save_room_config():
    rows = roomConfigContainer.querySelectorAll("div.flex")
    config = {}
    for row in rows:
        name = row.querySelector(".room-name").value.strip()
        cap = row.querySelector(".room-capacity").value.strip()
        loc = row.querySelector(".room-location").value.strip()
        if name:
            config[name] = {"capacity": int(cap) if cap else 30, "location": loc}
    global currentRoomConfig
    currentRoomConfig = config
    localStorage.setItem(ROOM_CONFIG_KEY, json.dumps(config))
    localStorage.setItem(COLLEGE_NAME_KEY, collegeNameInput.value)
    roomConfigStatus.textContent = "Room settings saved!"
    setTimeout(lambda: roomConfigStatus.textContent = "", 2000)

loadRoomConfig()

# === CSV LOAD ===
loadCsvButton.onclick = lambda e: load_csv_file()
def load_csv_file():
    file = correctedCsvUpload.files[0]
    if not file:
        csvLoadStatus.textContent = "Please select a CSV file."
        return
    document.getElementById("pdf-file").disabled = True
    document.getElementById("run-button").disabled = True
    reader = FileReader()
    reader.onload = create_proxy(lambda e: parseCsvAndLoadData(e.target.result))
    reader.readAsText(file)

def parseCsvAndLoadData(csvText):
    try:
        lines = csvText.strip().split("\n")
        headers = lines[0].split(",")
        dateIdx = headers.index("Date")
        timeIdx = headers.index("Time")
        courseIdx = headers.index("Course")
        regIdx = headers.index("Register Number")
        nameIdx = headers.index("Name")

        data = []
        summary = {}
        for line in lines[1:]:
            if not line.strip(): continue
            parts = line.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/)
            parts = [p.strip().strip('"') for p in parts]
            if len(parts) != len(headers): continue
            s = {
                "Date": parts[dateIdx],
                "Time": parts[timeIdx],
                "Course": parts[courseIdx],
                "Register Number": parts[regIdx],
                "Name": parts[nameIdx]
            }
            data.append(s)
            key = f"{s['Date']}_{s['Time']}_{s['Course']}"
            if key not in summary:
                summary[key] = {"Date": s["Date"], "Time": s["Time"], "Course": s["Course"], "Student Count": 0}
            summary[key]["Student Count"] += 1

        jsonDataStore.innerHTML = json.dumps(data)
        qPaperDataStore.innerHTML = json.dumps(list(summary.values()))
        localStorage.setItem(BASE_DATA_KEY, json.dumps(data))
        csvLoadStatus.textContent = f"Loaded {len(data)} records."
        csvLoadStatus.className = "text-sm font-medium text-green-600 mt-2 block h-5"
        enable_reports()
        disable_absentee_tab(False)
        disable_qpcode_tab(False)
        populate_session_dropdown()
        populate_qp_code_session_dropdown()
        document.getElementById("pdf-file").disabled = False
        document.getElementById("run-button").disabled = False
    except Exception as e:
        console.error(e)
        csvLoadStatus.textContent = "Error parsing CSV."
        csvLoadStatus.className = "text-sm font-medium text-red-600 mt-2 block h-5"
        document.getElementById("pdf-file").disabled = False
        document.getElementById("run-button").disabled = False

# === ABSENTEE LOGIC ===
def disable_absentee_tab(disabled):
    navButtons["absentees"].disabled = disabled
    if disabled:
        absenteeLoader.classList.remove("hidden")
        absenteeContentWrapper.classList.add("hidden")
        navButtons["absentees"].classList.add("opacity-50", "cursor-not-allowed")
    else:
        absenteeLoader.classList.add("hidden")
        absenteeContentWrapper.classList.remove("hidden")
        navButtons["absentees"].classList.remove("opacity-50", "cursor-not-allowed")

def populate_session_dropdown():
    global allStudentData, allStudentSessions
    allStudentData = json.loads(jsonDataStore.innerHTML or "[]")
    if not allStudentData:
        disable_absentee_tab(True)
        return
    sessions = set(f"{s['Date']} | {s['Time']}" for s in allStudentData)
    allStudentSessions = sorted(sessions)
    today = window.Date().toLocaleDateString("en-GB").replace(/\//g, ".")
    default = next((s for s in allStudentSessions if s.startswith(today)), allStudentSessions[0] if allStudentSessions else "")

    sessionSelect.innerHTML = "<option value=''>-- Select a Session --</option>" + "".join(f"<option value='{s}'>{s}</option>" for s in allStudentSessions)
    reportsSessionSelect.innerHTML = "<option value='all'>All Sessions</option>" + "".join(f"<option value='{s}'>{s}</option>" for s in allStudentSessions)
    if default:
        sessionSelect.value = default
        sessionSelect.dispatchEvent(window.Event("change"))
        reportsSessionSelect.value = default

    reportFilterSection.classList.remove("hidden")
    filterSessionRadio.checked = True
    reportsSessionDropdownContainer.classList.remove("hidden")

sessionSelect.onchange = lambda e: load_session(sessionSelect.value)
def load_session(key):
    if not key:
        absenteeSearchSection.classList.add("hidden")
        absenteeListSection.classList.add("hidden")
        generateAbsenteeReportButton.disabled = True
        currentAbsenteeListDiv.innerHTML = ""
        return
    absenteeSearchSection.classList.remove("hidden")
    absenteeListSection.classList.remove("hidden")
    generateAbsenteeReportButton.disabled = False
    load_absentee_list(key)

absenteeSearchInput.oninput = lambda e: search_student()
def search_student():
    query = absenteeSearchInput.value.upper()
    if len(query) < 3:
        autocompleteResults.classList.add("hidden")
        return
    date, time = sessionSelect.value.split(" | ")
    matches = [s for s in allStudentData if s["Date"] == date and s["Time"] == time and query in s["Register Number"].upper()][:10]
    if matches:
        autocompleteResults.innerHTML = "".join(
            f"<div class='autocomplete-item' onclick='select_student({json.dumps(s)})'>{s['Register Number'].replace(query, f'<strong>{query}</strong>')} ({s['Name']})</div>"
            for s in matches
        )
        autocompleteResults.classList.remove("hidden")
    else:
        autocompleteResults.classList.add("hidden")

window.select_student = lambda s: select_student(s)
def select_student(s):
    global selectedStudent
    selectedStudent = s
    absenteeSearchInput.value = s["Register Number"]
    autocompleteResults.classList.add("hidden")
    date, time = sessionSelect.value.split(" | ")
    session_students = [x for x in allStudentData if x["Date"] == date and x["Time"] == time]
    allocated = performRoomAllocation(session_students)
    alloc_s = next((x for x in allocated if x["Register Number"] == s["Register Number"]), None)
    room = alloc_s["Room No"] if alloc_s else "N/A"
    loc = f" ({currentRoomConfig.get(room, {}).get('location', '')})" if room in currentRoomConfig else ""
    selectedStudentName.textContent = s["Name"]
    selectedStudentCourse.textContent = s["Course"]
    selectedStudentRoom.textContent = f"Room: {room}{loc}"
    selectedStudentDetails.classList.remove("hidden")
    addAbsenteeButton.disabled = False

addAbsenteeButton.onclick = lambda e: add_absentee()
def add_absentee():
    if not selectedStudent: return
    reg = selectedStudent["Register Number"]
    if reg in currentAbsenteeList:
        alert(f"{reg} already in list.")
        return
    currentAbsenteeList.append(reg)
    save_absentee_list(sessionSelect.value)
    render_absentee_list()
    clear_absentee_search()

def clear_absentee_search():
    global selectedStudent
    selectedStudent = None
    absenteeSearchInput.value = ""
    autocompleteResults.classList.add("hidden")
    selectedStudentDetails.classList.add("hidden")
    addAbsenteeButton.disabled = True

def load_absentee_list(key):
    global currentAbsenteeList
    all_abs = json.loads(localStorage.getItem(ABSENTEE_LIST_KEY) or "{}")
    currentAbsenteeList = all_abs.get(key, [])
    render_absentee_list()

def save_absentee_list(key):
    all_abs = json.loads(localStorage.getItem(ABSENTEE_LIST_KEY) or "{}")
    all_abs[key] = currentAbsenteeList
    localStorage.setItem(ABSENTEE_LIST_KEY, json.dumps(all_abs))

def render_absentee_list():
    date, time = sessionSelect.value.split(" | ")
    session_students = [s for s in allStudentData if s["Date"] == date and s["Time"] == time]
    allocated = performRoomAllocation(session_students)
    room_map = {s["Register Number"]: s["Room No"] for s in allocated}
    currentAbsenteeListDiv.innerHTML = ""
    if not currentAbsenteeList:
        currentAbsenteeListDiv.innerHTML = "<em class='text-gray-500'>No absentees marked.</em>"
        return
    for reg in currentAbsenteeList:
        room = room_map.get(reg, "N/A")
        loc = f" ({currentRoomConfig.get(room, {}).get('location', '')})" if room in currentRoomConfig else ""
        div = document.createElement("div")
        div.className = "flex justify-between items-center p-2 bg-white border border-gray-200 rounded"
        div.innerHTML = f"<span class='font-medium'>{reg}</span><span class='text-sm text-gray-500'>{room}{loc}</span><button class='text-xs text-red-600 hover:text-red-800 font-medium' onclick='remove_absentee(\"{reg}\")'>&times; Remove</button>"
        currentAbsenteeListDiv.appendChild(div)

window.remove_absentee = lambda reg: remove_absentee(reg)
def remove_absentee(reg):
    global currentAbsenteeList
    currentAbsenteeList = [r for r in currentAbsenteeList if r != reg]
    save_absentee_list(sessionSelect.value)
    render_absentee_list()

# === QP CODES (FIXED) ===
def disable_qpcode_tab(disabled):
    navButtons["qpcodes"].disabled = disabled
    if disabled:
        qpcodeLoader.classList.remove("hidden")
        qpcodeContentWrapper.classList.add("hidden")
        navButtons["qpcodes"].classList.add("opacity-50", "cursor-not-allowed")
    else:
        qpcodeLoader.classList.add("hidden")
        qpcodeContentWrapper.classList.remove("hidden")
        navButtons["qpcodes"].classList.remove("opacity-50", "cursor-not-allowed")

def loadQPCodes():
    global qpCodeMap
    qpCodeMap = json.loads(localStorage.getItem(QP_CODE_LIST_KEY) or "{}")

def cleanCourseKey(name):
    if not name: return ""
    return re.sub(r"[^a-z0-9()]", "", name.lower().replace(" ", ""))

def populate_qp_code_session_dropdown():
    global allStudentData
    if not allStudentData:
        allStudentData = json.loads(jsonDataStore.innerHTML or "[]")
    if not allStudentData:
        disable_qpcode_tab(True)
        return
    sessions = set(f"{s['Date']} | {s['Time']}" for s in allStudentData)
    allStudentSessions = sorted(sessions)
    today = window.Date().toLocaleDateString("en-GB").replace(/\//g, ".")
    default = next((s for s in allStudentSessions if s.startswith(today)), None)
    sessionSelectQP.innerHTML = "<option value=''>-- Select a Session --</option>" + "".join(f"<option value='{s}'>{s}</option>" for s in allStudentSessions)
    if default:
        sessionSelectQP.value = default
        sessionSelectQP.dispatchEvent(window.Event("change"))

sessionSelectQP.onchange = lambda e: load_qp_session(sessionSelectQP.value)
def load_qp_session(key):
    if not key:
        qpEntrySection.classList.add("hidden")
        saveQpCodesButton.disabled = True
        return
    qpEntrySection.classList.remove("hidden")
    render_qp_code_list(key)

def render_qp_code_list(session_key):
    date, time = session_key.split(" | ")
    session_students = [s for s in allStudentData if s["Date"] == date and s["Time"] == time]
    courses = sorted(set(s["Course"] for s in session_students))
    loadQPCodes()
    session_codes = qpCodeMap.get(session_key, {})
    html = []
    for course in courses:
        key = cleanCourseKey(course)
        if not key:
            console.warn(f"Skipping unkeyable course: {course}")
            continue
        code = session_codes.get(key, "")
        html.append(f"""
            <div class="flex items-center gap-3 p-2 border-b border-gray-200">
                <label class="font-medium text-gray-700 w-2/3 text-sm">{course}</label>
                <input type="text" class="qp-code-input block w-1/3 p-2 border border-gray-300 rounded-md shadow-sm text-sm" value="{code}" data-course="{key}" placeholder="Enter QP Code">
            </div>
        """)
    qpCodeContainer.innerHTML = "".join(html) if html else "<p class='text-center text-gray-500'>No courses found.</p>"
    saveQpCodesButton.disabled = False
    qpCodeStatus.textContent = ""

saveQpCodesButton.onclick = lambda e: save_qp_codes()
def save_qp_codes():
    session_key = sessionSelectQP.value
    if not session_key:
        alert("No session selected.")
        return
    loadQPCodes()
    this_session = {}
    inputs = qpCodeContainer.querySelectorAll(".qp-code-input")
    for inp in inputs:
        key = inp.dataset.course
        val = inp.value.strip()
        if key:
            this_session[key] = val  # Save even if blank
    qpCodeMap[session_key] = this_session
    localStorage.setItem(QP_CODE_LIST_KEY, json.dumps(qpCodeMap))
    qpCodeStatus.className = "text-sm text-green-600 font-medium text-center h-5 mt-4"
    qpCodeStatus.textContent = "QP Codes saved successfully!"
    setTimeout(lambda: qpCodeStatus.textContent = "", 2000)

qpCodeContainer.oninput = lambda e: (
    qpCodeStatus.classList.remove("text-green-600"),
    qpCodeStatus.classList.add("text-red-600"),
    qpCodeStatus.textContent = "Unsaved changes... Click SAVE QP CODES to commit."
) if e.target.classList.contains("qp-code-input") else None

# === INITIALIZATION ===
def enable_reports():
    generateReportButton.disabled = False
    generateDaywiseReportButton.disabled = False
    generateQPaperReportButton.disabled = False

def load_initial_data():
    loadRoomConfig()
    saved = localStorage.getItem(BASE_DATA_KEY)
    if saved:
        try:
            data = json.loads(saved)
            if data:
                summary = {}
                for s in data:
                    key = f"{s['Date']}_{s['Time']}_{s['Course']}"
                    if key not in summary:
                        summary[key] = {"Date": s["Date"], "Time": s["Time"], "Course": s["Course"], "Student Count": 0}
                    summary[key]["Student Count"] += 1
                jsonDataStore.innerHTML = json.dumps(data)
                qPaperDataStore.innerHTML = json.dumps(list(summary.values()))
                enable_reports()
                disable_absentee_tab(False)
                disable_qpcode_tab(False)
                populate_session_dropdown()
                populate_qp_code_session_dropdown()
                statusLog.innerHTML = f"<p class='mb-1 text-green-700'>&gt; [{window.Date().toLocaleTimeString()}] Loaded data from previous session.</p>"
                statusLog.scrollTop = statusLog.scrollHeight
        except Exception as e:
            console.error(e)
            localStorage.removeItem(BASE_DATA_KEY)

# Run on load
load_initial_data()

# Prevent conflicts
document.getElementById("pdf-file").onchange = lambda e: (
    correctedCsvUpload.disabled := True,
    loadCsvButton.disabled := True
) if document.getElementById("pdf-file").files.length else (
    correctedCsvUpload.disabled := False,
    loadCsvButton.disabled := False
)
correctedCsvUpload.onchange = lambda e: (
    document.getElementById("pdf-file").disabled := True,
    document.getElementById("run-button").disabled := True
) if correctedCsvUpload.files.length else (
    document.getElementById("pdf-file").disabled := False,
    document.getElementById("run-button").disabled := False
)

# Master Reset
document.getElementById("master-reset-button").onclick = lambda e: (
    window.confirm("Clear ALL data?") and window.confirm("ABSOLUTELY SURE?") and (
        localStorage.clear(),
        window.alert("Data cleared. Reloading..."),
        window.location.reload()
    )
)
    </py-script>

    <script>
        // === JAVASCRIPT FALLBACKS ===
        document.addEventListener("DOMContentLoaded", () => {
            // Ensure PyScript loads
            if (typeof pyscript === "undefined") {
                document.body.innerHTML = "<h1>PyScript failed to load. Please check your internet connection.</h1>";
            }
        });
    </script>
</body>
</html>
